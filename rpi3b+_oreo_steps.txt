// https://github.com/444ghost

sudo apt-get install openjdk-8-jdk

sudo apt-get install gnupg flex gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache libgl1-mesa-dev libxml2-utils xsltproc unzip openjdk-8-jdk git phablet-tools python-mako android-tools-adb

sudo apt-get install gcc-arm-linux-gnueabihf

mkdir aosp

cd aosp

repo init -u https://android.googlesource.com/platform/manifest -b android-8.1.0_r33
git clone https://github.com/android-rpi/local_manifests .repo/local_manifests -b oreo

repo sync

cd kernel/rpi

ARCH=arm scripts/kconfig/merge_config.sh arch/arm/configs/bcm2709_defconfig kernel/configs/android-base.config kernel/configs/android-recommended.config

// processors BCM2835, BCM2836, BCM2837 for rpi b+, rpi2 b, rpi3 b
// packages or hardware BCM2708, BCM2709, BCM2709
// https://www.raspberrypistarterkits.com/comparison/raspberry-pi-3-pi-2-pi-b-benchmark-review/


ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make zImage

ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make dtbs

// applying the patches found at https://github.com/android-rpi/device_brcm_rpi3/wiki/Oreo-:-patch-framework-source

cd ~/aosp
source build/envsetup.sh
lunch rpi3-eng
make ramdisk systemimage

// now because this VirtualBox settings don't allow the host USB connection, create a local partition on the guest and make bootable image
// https://askubuntu.com/questions/667291/create-blank-disk-image-for-file-storage

dd if=/dev/zero of=image.img iflag=fullblock bs=1M count=8000 && sync // make a blank 8G image.img
sudo apt-get install tree
tree
losetup
sudo losetup loop1 image.img // losetup gives the list of attached lookback devices, if it doesn't give out, then loop0 I think actually
losetup
sudo apt-get install gparted
sudo -H gparted /dev/lopo1 // choose msdos
			   // first partition 512M as fat16 "boot" 
 			   // second partition 512M as ex4 "system"	
			   // third partition for the rest as ex4 "userdata"
			   // right click the first partition, check "bootable"
sudo dd if=out/target/product/rpi3/system.img of=/dev/loop1p2 bs=1M
sudo fdisk -l
mkdir temp
sudo mount /dev/loop1p1 temp/
sudo cp device/brcm/rpi3/boot/* temp/
sudo cp kernel/rpi/arch/arm/boot/zImage temp/
sudo cp kernel/rpi/arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dtb temp/
sudo cp kernel/rpi/arch/arm/boot/dts/overlays/vc4-kms-v3d.dtbo temp/
sudo cp out/target/product/rpi3/ramdisk.img temp/


